### LAB-MITRE-ATT&CK-Discovery

# Objective

Use Wireshark to identify the Network Service Discovery technique within packet captures and detect suspicious activities. Understand how this discovery technique appears in packet captures and reinforce the concept of the TCP 3-way handshake.

# Requirement 

File: DISCOVERY-SCAN.zip
SHA256: A9F94CBB85E3F3BF93F1F1DAA4CF01A1BFA69DD1DFECAB94FC7AA4D7C4F16D8A

Wireshark installed and configured (I am using version 4.2.4)

# Lab Answers

1) What is the IP that is responsible for this discovery technique?

Answer: IP: 192.168.1.212

2) What date & time was the first SYN event? (UTC)

Answer: Date/time: 2024-02-02 14:40:36 UTC

3) What packet number was the first SYN/ACK on?

Answer: Packet number: 26

4) How many IPs did the sender target?

Answer: IPs: 4

5) How many distinct (unique) ports did the attacker scan for?

Answer: Distinct ports: 20

6) Which IPs have RDP open?

Answer: IPs: 192.168.1.102 & 192.168.1.104

# Recap of Findings

The source 192.168.1.212 was found performing a SYN scan targeting the 4 IPs 192.168.1.101-104.
This scan was looking for 20 distinct ports and all IPs have the following ports open: 135, 139, 445, but the 2 IPs .102 & .104 have port 3389 open as well.

## üìù Lab Takeaways ‚Äì PCAP Analysis & SYN Scan Detection  

üìå **PCAPs in Production Environments**  
- Full packet captures (**PCAPs**) are rare in most production environments due to storage and performance costs.  
- If available, PCAPs are a **valuable resource** during investigations and threat hunting.  

üìå **Lab Findings**  
- A **SYN scan** was detected, originating from an IP ending in **.212**.  
- This scan was generated by **Nmap**, a well-known network scanning tool.  
- By analyzing the **TCP flags**, specifically looking at hosts that respond with **SYN/ACK**, we can quickly identify **open ports**.  

üìå **Threat Hunting Opportunity**  
- SYN scans help uncover **unexpected open services**.  
- Example: spotting **Remote Desktop Protocol (RDP)** exposure can reveal potential attack vectors.  
- Regular scanning for open ports is a **proactive defense strategy** to detect misconfigurations or unauthorized services.  

‚ö†Ô∏è **Key Point**: If PCAPs are available, always use them to validate suspicious activity, confirm whether ports/services are exposed, and correlate with other logs (firewall, IDS/IPS, SIEM).  

## ‚ö° Lab Step-By-Step ‚Äì Network Service Discovery via PCAP  

### üîç Step 1: MITRE ATT&CK Mapping  
- Navigate to the **MITRE ATT&CK Framework**.  
- Under the **Discovery** tactic, select the technique:  
  - **T1046 ‚Äì Network Service Discovery**  
- üìñ This technique highlights how adversaries leverage **third-party tools** (e.g., Nmap) to:  
  - Discover additional assets in an environment  
  - Identify **open ports & services**  
  - Pinpoint potential vulnerabilities for exploitation  

### üõ†Ô∏è Why This Matters  
- Network scans like this often **precede lateral movement or privilege escalation**.  
- By analyzing these scans, defenders can detect:  
  - **Unauthorized reconnaissance**  
  - **Misconfigured systems** exposing unnecessary services  
  - Early indicators of compromise (**IOC**) before actual exploitation  

‚ö†Ô∏è **Defender Insight**: Always baseline normal discovery activity (from vulnerability scanners, IT monitoring, etc.) to distinguish legitimate activity from malicious reconnaissance.  

<img width="1281" height="504" alt="1" src="https://github.com/user-attachments/assets/353362e9-1509-4069-964b-9fd4a26055be" />

Open up our PCAP with Wireshark called Discovery-Scan.pcap and begin checking the Capture File Properties. We see the first packet was on 2024-02-02 14:40:36 (UTC), and the last packet 14:40:43 (UTC), with a duration of 6 seconds.

<img width="520" height="431" alt="2" src="https://github.com/user-attachments/assets/20e9f79c-d8d8-4e58-ad1a-5fe5d10b9870" />

Then, we are going to look at the Protocol Hierarchy to see what exists in this packet capture.

<img width="514" height="62" alt="3" src="https://github.com/user-attachments/assets/c5eaefb1-e5c7-4980-9d5c-042c3f8d27bc" />

We see various different protocols some which could be interesting such as HTTP and DNS.


<img width="525" height="159" alt="4" src="https://github.com/user-attachments/assets/7850bc53-cca2-44b3-8843-401e64298dea" />

Then, we are going to do the same for Conversations.

<img width="521" height="295" alt="5" src="https://github.com/user-attachments/assets/7282e697-897c-4589-bd52-230055c8eb08" />

Clicking on the IPv4 tab, we will sort it by bytes. We see the top 2 IPs are external, however, if we think about the Discovery tactic, the objective for the attacker is to identify assets within the environment. This means that outbound connections towards external IPs would likely not be of interest yet.

<img width="747" height="256" alt="6" src="https://github.com/user-attachments/assets/873c7834-0875-4ce9-9720-2bc46230150b" />

Instead, we want to look at internal communications, which we observe in lines 3-6. These connections are coming from 192.168.1.212 towards .101 to .104.

<img width="747" height="256" alt="7" src="https://github.com/user-attachments/assets/6c323195-821e-42f6-b1e3-1f7273387b63" />

Looking at the TCP tab and sorting it by ports. The IP of .212 seems to be scanning 4 internal IPs, looking for ports 21, 22, 23, 25, 53, 80, 110, 111, 135, 139, 143, 443, 445, 993, 995, 1723, 3306, 3389, 5900, and 8080, which is a total of 20 distinct ports.

<img width="749" height="314" alt="8" src="https://github.com/user-attachments/assets/5c02cb65-7a0b-4f36-a8fb-357694136afc" />

Scanning is a popular technique that attackers love to use to discover what ports/services are open. Knowing this information can allow attackers to pivot or exploit the target machine to move laterally. To check which IPs have open ports, we must remember the TCP 3-way handshake.

As a self-reminder, a TCP connection begins when a client sends a SYN flag to the target machine. If the target machine is alive and ready to accept connections, it should send a SYN/ACK flag back to the client, otherwise it should send a RST/ACK. Once the client receives the SYN/ACK, it will then send a final ACK back to the target, and this will establish a TCP connection. When we look at a port scan, any ports that are open on the target machine should send a SYN/ACK flag back to the client machine.

Knowing this, we can look for any SYN/ACK flags to the destination IP of 192.168.1.212. Remember, those that have the port open will be responding BACK to the IP of 192.168.1.212, hence why .212 is the destination. The first SYN event was on packet 11 at 2024-02-02 14:40:36, and the first SYN ACK we see is on packet number 26.

<img width="1458" height="816" alt="10" src="https://github.com/user-attachments/assets/4d7bb6ab-cfad-4958-8139-9423d4cf4dd4" />
<img width="1166" height="243" alt="9" src="https://github.com/user-attachments/assets/6d126110-bd16-4e11-bf24-82073d495b1b" />

Selecting the SYN/ACK packet and expand the Transmission Control Protocol field in the Packet detail pane. we should see the flags tab where it shows 0x012 (SYN, ACK).

<img width="753" height="317" alt="11" src="https://github.com/user-attachments/assets/7450b5e3-59ee-448a-ad8f-185621158d03" />

Right click this flag and select ‚ÄúPrepare as filter‚Äù and click on ‚ÄúSelected‚Äù. Now our filter should automatically update.

<img width="748" height="509" alt="12" src="https://github.com/user-attachments/assets/7581bf28-4155-4b3a-bb1c-1a377c21f4bb" />
<img width="738" height="148" alt="13" src="https://github.com/user-attachments/assets/9baa1805-650f-40cb-990a-242fad1edc6c" />

Before we hit enter, we want to include the destination IP in our filter as well. To do this, we can right click the destination IP value of 192.168.1.212, select Prepare as Filter, click on ‚Äú‚Ä¶and Selected‚Äù

<img width="750" height="315" alt="14" src="https://github.com/user-attachments/assets/6f90d394-dfff-4506-9e02-74e25993b487" />
<img width="761" height="114" alt="15" src="https://github.com/user-attachments/assets/ad6e833c-0c49-40c9-80f0-7c40da1a3c88" />

Now we can hit enter to apply our filter. We should have a total of 14 packets showing all the open ports and IPs that responded back to the IP of .212. Sort the source IPs so we can see what ports are open for each IP.

<img width="755" height="362" alt="16" src="https://github.com/user-attachments/assets/a38eaf23-1cae-4ac1-8af4-f531cfe71796" />

From here we can answer all the questions, with this last request we have the IPs that have open ports.

192.168.1.101 has ports: 135, 445 & 139 open.
192.168.1.102 has ports: 3389, 135, 445 & 139 open.
192.168.1.103 has 135, 445 & 139 open.
192.168.1.104 has 3389, 135, 445 & 139 open.
